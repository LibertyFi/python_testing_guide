
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
        <link rel="next" href="../guide/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Tutorial - Python Testing Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#welcome-to-the-python-unit-tests-tutorial" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Python Testing Guide" class="md-header__button md-logo" aria-label="Python Testing Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Python Testing Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Python Testing Guide" class="md-nav__button md-logo" aria-label="Python Testing Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Python Testing Guide
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-unit-tests-are-for" class="md-nav__link">
    <span class="md-ellipsis">
      What Unit Tests Are For
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-write-unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      How to Write Unit Tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How to Write Unit Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-basics" class="md-nav__link">
    <span class="md-ellipsis">
      The Basics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Project structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-big-should-each-unit-test-be" class="md-nav__link">
    <span class="md-ellipsis">
      How big should each unit test be?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mocking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-mocking" class="md-nav__link">
    <span class="md-ellipsis">
      What is mocking?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking-a-function" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking a function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking-an-object" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking an object
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mocking an object">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simple-mock" class="md-nav__link">
    <span class="md-ellipsis">
      Simple Mock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specifying-the-mocks-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying the Mock's Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-mock-is-not-enough" class="md-nav__link">
    <span class="md-ellipsis">
      When Mock is not enough
    </span>
  </a>
  
    <nav class="md-nav" aria-label="When Mock is not enough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#magicmock" class="md-nav__link">
    <span class="md-ellipsis">
      MagicMock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asyncmock" class="md-nav__link">
    <span class="md-ellipsis">
      AsyncMock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking-a-class" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking a class
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-fixtures" class="md-nav__link">
    <span class="md-ellipsis">
      Test Fixtures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Fixtures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-are-test-fixtures" class="md-nav__link">
    <span class="md-ellipsis">
      What are test fixtures?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-use-test-fixtures" class="md-nav__link">
    <span class="md-ellipsis">
      How to use test fixtures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-mocking" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Mocking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Mocking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Side Effects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-mock-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Checking Mock Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-that-an-exception-is-caught" class="md-nav__link">
    <span class="md-ellipsis">
      Check that an exception is caught
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-that-an-exception-is-raised" class="md-nav__link">
    <span class="md-ellipsis">
      Check that an exception is raised
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Guide
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-unit-tests-are-for" class="md-nav__link">
    <span class="md-ellipsis">
      What Unit Tests Are For
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-write-unit-tests" class="md-nav__link">
    <span class="md-ellipsis">
      How to Write Unit Tests
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How to Write Unit Tests">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-basics" class="md-nav__link">
    <span class="md-ellipsis">
      The Basics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#project-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Project structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-big-should-each-unit-test-be" class="md-nav__link">
    <span class="md-ellipsis">
      How big should each unit test be?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mocking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-mocking" class="md-nav__link">
    <span class="md-ellipsis">
      What is mocking?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking-a-function" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking a function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking-an-object" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking an object
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mocking an object">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simple-mock" class="md-nav__link">
    <span class="md-ellipsis">
      Simple Mock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specifying-the-mocks-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Specifying the Mock's Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-mock-is-not-enough" class="md-nav__link">
    <span class="md-ellipsis">
      When Mock is not enough
    </span>
  </a>
  
    <nav class="md-nav" aria-label="When Mock is not enough">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#magicmock" class="md-nav__link">
    <span class="md-ellipsis">
      MagicMock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asyncmock" class="md-nav__link">
    <span class="md-ellipsis">
      AsyncMock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mocking-a-class" class="md-nav__link">
    <span class="md-ellipsis">
      Mocking a class
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-fixtures" class="md-nav__link">
    <span class="md-ellipsis">
      Test Fixtures
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test Fixtures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-are-test-fixtures" class="md-nav__link">
    <span class="md-ellipsis">
      What are test fixtures?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-use-test-fixtures" class="md-nav__link">
    <span class="md-ellipsis">
      How to use test fixtures
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-mocking" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Mocking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Mocking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#side-effects" class="md-nav__link">
    <span class="md-ellipsis">
      Side Effects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checking-mock-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Checking Mock Calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      Exceptions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-that-an-exception-is-caught" class="md-nav__link">
    <span class="md-ellipsis">
      Check that an exception is caught
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-that-an-exception-is-raised" class="md-nav__link">
    <span class="md-ellipsis">
      Check that an exception is raised
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="welcome-to-the-python-unit-tests-tutorial">Welcome to the Python unit tests tutorial</h1>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Python 3.11+</li>
<li>pytest installed as a dev dependency</li>
<li>pytest-asyncio installed as a dev dependency</li>
</ul>
<h2 id="what-unit-tests-are-for">What Unit Tests Are For</h2>
<ol>
<li><strong>Detecting Bugs Early</strong>: Unit tests catch errors and bugs in specific functions or methods before they become larger issues in the overall system.</li>
<li><strong>Ensuring Code Quality</strong>: They validate that the code behaves as intended, improving reliability.</li>
<li><strong>Facilitating Refactoring</strong>: With a suite of unit tests, you can confidently make changes to your codebase knowing that tests will alert you if something breaks.</li>
<li><strong>Documenting Behavior</strong>: Tests serve as documentation by illustrating how functions or methods are intended to work.</li>
<li><strong>Improving Development Speed</strong>: Though writing tests may seem like extra work, they save time in the long run by reducing debugging time and ensuring stability.</li>
</ol>
<h2 id="how-to-write-unit-tests">How to Write Unit Tests</h2>
<h3 id="the-basics">The Basics</h3>
<h4 id="project-structure">Project structure</h4>
<p>The test files should be located in the <code>tests</code> directory.
Then, for each source file/module, there should be a corresponding test file.
The tests directory should have the same directory structure as the source code.</p>
<p>For example, if we have the following project structure:</p>
<div class="highlight"><pre><span></span><code>src/
├── level_0/
│ ├── calculator.py
</code></pre></div>
<p>The test files should be located in the <code>tests</code> directory.</p>
<div class="highlight"><pre><span></span><code>tests/
├── level_0/
│ ├── test_calculator.py
</code></pre></div>
<h4 id="how-big-should-each-unit-test-be">How big should each unit test be?</h4>
<p>The goal of unit testing is to verify that small, isolated units of code (usually functions or methods) perform correctly and handle edge cases as designed.</p>
<p>As such a unit test should be as simple as possible and test only one thing.</p>
<p>Take the following example of a calculator module:</p>
<div class="highlight"><span class="filename">calculator.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="k">def</span><span class="w"> </span><span class="nf">subtract</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>


<span class="k">def</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>


<span class="k">def</span><span class="w"> </span><span class="nf">divide</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot divide by zero&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
</code></pre></div>
<p>We could test that module with a single test, like so:</p>
<div class="highlight"><span class="filename">test_calculator.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_operations</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">assert</span> <span class="n">subtract</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">subtract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
    <span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">assert</span> <span class="n">divide</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;divide by zero&quot;</span><span class="p">):</span>
        <span class="n">divide</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>But that test is testing way too many different things. If it breaks, all we know is that the calculator doesn’t work any more, we don’t know which parts still work and which part broke.</p>
<p>Whereas if we split it into true unit tests, like so:</p>
<div class="highlight"><span class="filename">test_calculator.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_add</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_subtract</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">subtract</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">subtract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_multiply</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
    <span class="k">assert</span> <span class="n">multiply</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_divide_valid</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">divide</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">divide</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_divide_by_zero</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;divide by zero&quot;</span><span class="p">):</span>
        <span class="n">divide</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>If one test breaks, we instantly know which part of the calculator is broken. We even have a specific test for the edge case of the division operation.</p>
<h3 id="mocking">Mocking</h3>
<h4 id="what-is-mocking">What is mocking?</h4>
<p>Mocking is a technique used to replace a function or method with a mock implementation in order to test the code that uses it.</p>
<p>Take the following example of a simple class:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.level_1.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">connect_to_server</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">connect_to_server</span><span class="p">()</span>
</code></pre></div>
<p>We could test the single method of the class like so:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">result</span>
</code></pre></div>
<p>But the <code>connect_to_server</code> function comes from an external module, which we don't control in the <code>session</code> module.
Each unit test should only test one unit of code. This test is actually testing both <code>session.connect</code> and <code>interface.connect_to_server</code>.
If the test fails, there is no way to tell if it's because of the <code>connect</code> method or the <code>connect_to_server</code> function.</p>
<h4 id="mocking-a-function">Mocking a function</h4>
<p>To properly test the above <code>connect</code> method, we should mock the <code>connect_to_server</code> function. Here's how we can do it, using the <code>patch</code> function (here in decorator form):</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.level_1.session.connect_to_server&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success</span><span class="p">(</span><span class="n">mock_connect_to_server</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">mock_connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="c1"># Check that the mock was called by the connect method</span>
    <span class="n">mock_connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="c1"># Check that the connect method returns the correct value</span>
    <span class="k">assert</span> <span class="n">connected</span>


<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.level_1.session.connect_to_server&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_connect_failure</span><span class="p">(</span><span class="n">mock_connect_to_server</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">mock_connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">connected</span>
</code></pre></div>
<p>Mocking the <code>connect_to_server</code> function has several benefits:</p>
<ul>
<li>we're only testing the <code>connect</code> method, regardless of the actual implementation of <code>connect_to_server</code></li>
<li>we're able to have two test cases for the <code>connect</code> method, one for when the connection is successful and one for when it's not because we control the return value of the mock</li>
<li>we're not executing the actual <code>connect_to_server</code> function, which could require a specific setup, make network requests, or even be an expensive operation</li>
</ul>
<div class="admonition danger">
<p class="admonition-title">Patch in the right place</p>
<p>When using the patch function, it's important to patch the function <strong>where it's used</strong>, not where it's defined.</p>
<p><img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /> <code>patch("src.level_1.session.connect_to_server")</code></p>
<p><img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /> <del><code>patch("src.level_1.interface.connect_to_server")</code></del></p>
</div>
<h4 id="mocking-an-object">Mocking an object</h4>
<p>Let's use the following class as an example:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.level_2.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServerInterface</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">()</span>
</code></pre></div>
<p>In order to test the <code>connect</code> method, we first need to instantiate a <code>Session</code> object, which requires an <code>ServerInterface</code> object.</p>
<p>Since we don't know what creating an actual <code>ServerInterface</code> object entails, and we don't want to test the <code>ServerInterface</code> class, we need to mock the <code>ServerInterface</code> object.</p>
<h5 id="simple-mock">Simple Mock</h5>
<p>The simplest way to mock an object is to use the <code>Mock</code> class, from the <code>unittest.mock</code> module.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>Here we create a <code>Mock</code> object and assign a return value to its <code>connect_to_server</code> attribute.</p>
<p>Now when the test calls <code>session.connect()</code>, it will call the <code>connect_to_server</code> method of the <code>Mock</code> instead of an actual <code>ServerInterface</code> object.</p>
<p>And since we control the mock, we can even check that the <code>connect_to_server</code> method is indeed called by the <code>connect</code> method.</p>
<h5 id="specifying-the-mocks-structure">Specifying the Mock's Structure</h5>
<p><code>Mock</code> generates attributes on the fly so that the mock can be used automatically without worrying about setting it up.
The downside of this is that you can use attributes that don't even exist on the original object.</p>
<p>Here's an example:</p>
<div class="highlight"><span class="filename">interface.py</span><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ServerInterface</span><span class="p">:</span>
    <span class="n">class_attribute</span> <span class="o">=</span> <span class="s2">&quot;This is a class attribute&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_attribute</span> <span class="o">=</span> <span class="s2">&quot;This is an instance attribute&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect_to_server</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Called actual connect_to_server&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_shouldnt_be_allowed</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># This doesn&#39;t raise an error, but it shouldn&#39;t be possible</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">not_an_actual_attribute</span> <span class="o">=</span> <span class="s2">&quot;This shouldn&#39;t be possible&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>The <code>ServerInterface</code> object we want to mock doesn't have a <code>not_an_actual_attribute</code> attribute, so we shouldn't allow the mock to have it.
Moreover, even if the <code>connect</code> method actually uses <code>not_an_actual_attribute</code>, this test will still pass even though the attribute doesn't actually exist, which will make <code>connect</code> crash at runtime.</p>
<p>Thankfully, there are ways to specify the structure of the mock object.</p>
<p>The best (strictest) way is to use the <code>spec_set</code> argument to specify to the <code>Mock</code> constructor the class of the object we want to mock:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_spec_set</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># This raises an AttributeError</span>
    <span class="c1"># interface.not_an_actual_attribute = &quot;This shouldn&#39;t be possible&quot;  # noqa: ERA001</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>This will raise an error if we try to access an attribute that doesn't exist in the <code>ServerInterface</code> class.</p>
<p>Unfortunately, instance attributes are not part of the class specification, so they don't exist as far as <code>spec_set</code> is concerned.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_spec_set_instance_attribute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># This works as expected</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">class_attribute</span> <span class="o">=</span> <span class="s2">&quot;This is a class attribute&quot;</span>
    <span class="c1"># This raises an AttributeError</span>
    <span class="c1"># interface.instance_attribute = &quot;This attribute doesn&#39;t exist when the mock is created&quot;  # noqa: ERA001</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>If you need to mock an instance attribute (or any attribute that is defined at runtime), you can use <code>spec</code> instead of <code>spec_set</code>:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_simple_spec_for_instance_attribute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">class_attribute</span> <span class="o">=</span> <span class="s2">&quot;This is a class attribute&quot;</span>
    <span class="c1"># Now this works</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">instance_attribute</span> <span class="o">=</span> <span class="s2">&quot;This is an instance attribute&quot;</span>
    <span class="c1"># But this will still raise an AttributeError</span>
    <span class="c1"># logging.info(f&quot;{interface.unset_instance_attribute}&quot;)  # noqa: ERA001</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title"><code>spec</code> vs <code>spec_set</code></p>
<p><code>spec</code> is not as strict as <code>spec_set</code>, it will simply ensure that an attribute can't be accessed if it has not been set, whether by the test or the specified class:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_simple_spec_is_lax</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># This will not raise an error</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">not_an_actual_attribute</span> <span class="o">=</span> <span class="s2">&quot;This doesn&#39;t exist in the specified class&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">One-liner syntax</p>
<p>You can also define the mock and its attributes at the same time if you prefer the one-liner syntax.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_simple_spec_one_liner</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span>
        <span class="n">spec</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">,</span>
        <span class="n">class_attribute</span><span class="o">=</span><span class="s2">&quot;This is a class attribute&quot;</span><span class="p">,</span>
        <span class="n">instance_attribute</span><span class="o">=</span><span class="s2">&quot;This is an instance attribute&quot;</span><span class="p">,</span>
        <span class="n">connect_to_server</span><span class="o">=</span><span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
</div>
<h4 id="when-mock-is-not-enough">When Mock is not enough</h4>
<p>Sometimes using <code>Mock</code> is not enough. Let's take this new example class:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.level_3.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServerInterface</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span>
    <span class="n">active_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_connections</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_connections</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">aconnect_to_server</span><span class="p">()</span>
</code></pre></div>
<h5 id="magicmock">MagicMock</h5>
<p>We can try testing the <code>connect</code> method with <code>Mock</code> as we did before:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_missing_magic_method</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
    <span class="c1"># This raises a TypeError because Mock doesn&#39;t implement the magic/special __add__ method so it can&#39;t effectively</span>
    <span class="c1"># mock an int</span>
    <span class="c1"># session.active_connections = Mock()  # noqa: ERA001</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>Unfortunately mocking the <code>active_connections</code> attribute with <code>Mock</code> doesn't work because <code>Mock</code> doesn't implement the magic/special <code>__add__</code> method so it can't effectively mock an <code>int</code>.</p>
<p>We could mock the <code>__add__</code> method ourselves, but that would be tedious and error-prone since it's not always obvious which magic methods are used by the code.</p>
<p>Fortunately, <code>Mock</code> has a subclass called <code>MagicMock</code> that automatically implements the magic/special methods:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_magic</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
    <span class="c1"># This works as expected because MagicMock automatically implements the magic/special methods, including __add__</span>
    <span class="n">session</span><span class="o">.</span><span class="n">active_connections</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>Using <code>MagicMock</code> we don't have to worry about mocking any magic/special methods ourselves.</p>
<div class="admonition tip">
<p class="admonition-title">Magic Methods</p>
<p>If you use the <code>spec</code> or <code>spec_set</code> arguments then only magic methods that exist in the spec will be created.
You can override the magic methods of a <code>MagicMock</code> by setting them just like you would with a normal <code>Mock</code>.</p>
</div>
<h5 id="asyncmock">AsyncMock</h5>
<p>We'd also like to test the <code>aconnect</code> method, but it's an async function so we can't use a simple <code>Mock</code> to mock it.</p>
<p>Fortunately, <code>Mock</code> has a subclass called <code>AsyncMock</code> that can be used to mock async functions:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_aconnect_async_mock</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="c1"># This raises a TypeError because the mock will simply return a boolean instead of a coroutine</span>
    <span class="c1"># interface.aconnect_to_server.return_value = True  # noqa: ERA001</span>
    <span class="c1"># We need to use AsyncMock to mock the async function properly</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">aconnect_to_server</span> <span class="o">=</span> <span class="n">AsyncMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">aconnect</span><span class="p">()</span>

    <span class="c1"># We could use assert_called_once() as well, but assert_awaited_once() is more specific</span>
    <span class="n">interface</span><span class="o">.</span><span class="n">aconnect_to_server</span><span class="o">.</span><span class="n">assert_awaited_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">AsyncMock calls</p>
<p>You can use <code>assert_awaited_once()</code> or similar methods to check that an async function is awaited and not just called.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Decorator for async tests</p>
<p>The <code>@pytest.mark.asyncio</code> decorator is required on each async test.</p>
</div>
<h4 id="mocking-a-class">Mocking a class</h4>
<p>Sometimes we need to mock a class and not just an object or a function.</p>
<p>Let's take the following example:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.level_4.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span> <span class="k">as</span> <span class="n">Db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.level_4.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServerInterface</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ServerInterface</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Db</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
            <span class="c1"># TODO: write some data to the database</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">()</span>
</code></pre></div>
<p>Instead of passing the interface as an argument when creating the <code>Session</code> object, it is instantiated by the class itself at initialization.</p>
<p>So we need to mock the full class, not just an instance of it.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.level_4.session.ServerInterface&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success</span><span class="p">(</span><span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>We use the <code>@patch</code> decorator to mock the <code>ServerInterface</code> class, then we create a <code>Mock</code> object and assign it to the <code>return_value</code> of the mock class.</p>
<div class="admonition danger">
<p class="admonition-title">Patch in the right place</p>
<p>When using the patch function, it's important to patch the function <strong>where it's used</strong>, not where it's defined.</p>
<p><img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /> <code>patch("src.level_4.session.ServerInterface")</code></p>
<p><img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /> <del><code>patch("src.level_4.interface.ServerInterface")</code></del></p>
</div>
<p>The test works fine, but we forgot to mock the <code>Database</code> class so the test is actually using the real Database, which could be dangerous!</p>
<p>So let's mock the <code>Database</code> class as well:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.level_4.session.ServerInterface&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;src.level_4.session.Db&quot;</span><span class="p">,</span> <span class="n">spec_set</span><span class="o">=</span><span class="n">Database</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_mock_db</span><span class="p">(</span><span class="n">mock_db</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">Connection</span><span class="p">)</span>
    <span class="n">mock_db</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_conn</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_conn</span><span class="o">.</span><span class="n">begin</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>Since the <code>Database</code> class is used with a context manager, using <code>with</code>, through its <code>get</code> method, the mock definition is a bit more complicated.</p>
<div class="admonition danger">
<p class="admonition-title">The order of patch decorators matters</p>
<p>The patch decorators automatically provide the test function with the mocks as arguments. The arguments are provided in the same order as the decorators are applied to the function, which is the opposite order as the decorators appear above the test function. Thus the first argument will match de decorator closest to the function and the last argument the furthest.</p>
</div>
<h3 id="test-fixtures">Test Fixtures</h3>
<p>Let's use a new example class:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.level_5.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">Database</span> <span class="k">as</span> <span class="n">Db</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.level_5.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConnectionCounter</span><span class="p">,</span> <span class="n">ServerInterface</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_counter</span><span class="p">:</span> <span class="n">ConnectionCounter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ServerInterface</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_counter</span> <span class="o">=</span> <span class="n">connection_counter</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Db</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
            <span class="c1"># TODO: write some data to the database</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_counter</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">connected</span>
</code></pre></div>
<h4 id="what-are-test-fixtures">What are test fixtures?</h4>
<p>In our example, any test of the <code>Session</code> class's <code>connect</code> method will need to mock the <code>ServerInterface</code> and <code>Database</code> classes as well as a <code>ConnectionCounter</code> object.
Duplicating the mock setup code would be a bad practice.</p>
<p>A test fixture allows us to create a test setup that is used by several tests.</p>
<p>It can create a mock and provide it to the tests:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_connection_counter</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Mock</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ConnectionCounter</span><span class="p">)</span>
</code></pre></div>
<p>It can also patch a class and provide the resulting mock to the tests:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_interface_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">MagicMock</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;src.level_5.session.ServerInterface&quot;</span><span class="p">,</span> <span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">mock</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Patch decorator or context manager</p>
<p>As we've already seen, the <code>patch</code> function can be used as a decorator, which applies the patch to the scope of the test function.
It can also be used as a context manager, in which case the patch is applied to the scope of the with block.</p>
</div>
<p>A test fixture can also return more complicated objects:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_db_connection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">MagicMock</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;src.level_5.session.Db&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">Database</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_db</span><span class="p">:</span>
        <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">Connection</span><span class="p">)</span>
        <span class="n">mock_db</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_conn</span>
        <span class="k">yield</span> <span class="n">mock_db</span><span class="p">,</span> <span class="n">mock_conn</span>
</code></pre></div>
<h4 id="how-to-use-test-fixtures">How to use test fixtures</h4>
<p>To use a test fixture, we just add it as an argument to the test function.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success</span><span class="p">(</span><span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mock_connection_counter</span><span class="p">:</span> <span class="n">Mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">mock_connection_counter</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_connection_counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<p>The fixture code will be executed automatically before the test function is executed.</p>
<p>To use it in another test, we just pass it as an argument to that function as well and it will be executed again.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_failure</span><span class="p">(</span><span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mock_connection_counter</span><span class="p">:</span> <span class="n">Mock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">mock_connection_counter</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_connection_counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">connected</span>
</code></pre></div>
<p>We've successfully avoided duplicating the mock setup code.</p>
<p>But what about the <code>Database</code> class? We haven't added it as an argument to our test functions. So is the actual Database called by our tests?
No! The <code>mock_db_connection</code> fixture was declared with the <code>autouse</code> flag, which means that it will be used automatically by all tests, without needing to pass it as an argument to the test function.</p>
<div class="admonition tip">
<p class="admonition-title">Seeing logs when running the tests</p>
<p>By default when you run the tests using <code>pytest</code>, the logs from your code are not displayed.
If you want to see them, you can run the tests with <code>-v --log-cli-level=INFO</code>.
In our example, if you activate the logs, you'll see that the logs from the actual <code>Database</code> class only show up if the <code>autouse</code> flag is not set.</p>
<div class="highlight"><span class="filename">database.py</span><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Connection</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Called actual begin&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Called actual commit&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p>But what if we want to check that the code under test actually calls the database? Since the <code>mock_db_connection</code> fixture is automatically used by all tests, we don't have a reference to the mock on which to call <code>assert_called_once()</code> or similar methods.</p>
<p>Fortunately, we can pass the <code>mock_db_connection</code> fixture as an explicit argument to the test function and then reference it in the test.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_success_mock_db</span><span class="p">(</span>
    <span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mock_connection_counter</span><span class="p">:</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">mock_db_connection</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">MagicMock</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">mock_conn</span> <span class="o">=</span> <span class="n">mock_db_connection</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">mock_connection_counter</span><span class="p">)</span>

    <span class="n">connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_conn</span><span class="o">.</span><span class="n">begin</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_conn</span><span class="o">.</span><span class="n">commit</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_connection_counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">connected</span>
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">Combining fixtures and patch decorators</p>
<p>The patch decorators automatically provide the test function with the mocks as arguments. The arguments are provided in the same order as the decorators are applied to the function, which is the opposite order as the decorators appear above the test function. The arguments for the test fixtures must come after the arguments for the patch decorators:
<div class="highlight"><pre><span></span><code><span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;xxx.b&quot;</span><span class="p">)</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;xxx.a&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_function</span><span class="p">(</span><span class="n">mock_a</span><span class="p">,</span> <span class="n">mock_b</span><span class="p">,</span> <span class="n">fixture_mock</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div></p>
</div>
<h3 id="advanced-mocking">Advanced Mocking</h3>
<h4 id="side-effects">Side Effects</h4>
<p>We've already seen that we can specify the return value of a mock.
But what if that's not enough?</p>
<p>Let's take the following example:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.level_6.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServerInterface</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span>
    <span class="n">connected</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ServerInterface</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">is_server_connected</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>We want to test the <code>start</code> method. It uses the <code>connect</code> method and the <code>is_server_connected</code> method so if we want to implement a proper unit test, we need to mock both, otherwise we're actually testing all three methods at the same time.</p>
<p>First of all, we can define a fixture for the <code>ServerInterface</code> class:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_interface_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">MagicMock</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;src.level_6.session.ServerInterface&quot;</span><span class="p">,</span> <span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">mock</span>
</code></pre></div>
<p>Second, we don't want our test to actually sleep for multiple seconds, we just want to check that it calls the <code>sleep</code> function, so let's define a fixture for the <code>time.sleep</code> function:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_sleep</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">MagicMock</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;src.level_6.session.time.sleep&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">mock</span>
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">Patch in the right place</p>
<p>Remember: when using the patch function, it's important to patch the function <strong>where it's used</strong>, not where it's defined.</p>
<p><img alt="✅" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2705.svg" title=":white_check_mark:" /> <code>patch("src.level_6.session.time.sleep")</code></p>
<p><img alt="❌" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/274c.svg" title=":x:" /> <del><code>patch("time.sleep")</code></del></p>
</div>
<p>But there are two problems that we've not encountered yet:</p>
<ul>
<li>the behavior of the <code>start</code> method depends on what the <code>connect</code> method does, and not what it returns. How can we mock the behavior of a method and not just its return value?</li>
<li><code>is_server_connected</code> is called multiple times and the behavior of the <code>start</code> method depends on the value returned by this method each time it's called. How can we set multiple successive return values for a mock?</li>
</ul>
<p>That's where the <code>side_effect</code> attribute comes in.</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_start_success</span><span class="p">(</span><span class="n">mock_sleep</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">is_server_connected</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">mock_sleep</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">session</span><span class="o">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span>

    <span class="n">session</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">mock_interface</span><span class="o">.</span><span class="n">is_server_connected</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">3</span>
</code></pre></div>
<p>The <code>side_effect</code> attribute can serve multiple purposes:</p>
<ul>
<li>if set to a specific value, the mock will return that value every time its called, it's equivalent to setting the <code>return_value</code> attribute</li>
<li>if set to an iterable, the mock will return successive values from the iterable each time its called</li>
<li>if set to a function, the mock will call the function every time its called</li>
</ul>
<p>Here we used the iterable and function cases.</p>
<p>If we don't specify the <code>side_effect</code>, the mock will not do anything, and that's a valid test case too!</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_start_not_connected</span><span class="p">(</span><span class="n">mock_sleep</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">mock_sleep</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>

    <span class="n">session</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">is_server_connected</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Mocking methods</p>
<p>It can be seen as overkill to mock the other methods of a given class when testing a single method even though each methods will have its own unit tests anyway. But by doing it this way, we're making sure that breaking one method will only break the tests of that specific method and not the tests of all methods which call it.</p>
</div>
<h4 id="checking-mock-calls">Checking Mock Calls</h4>
<p>We've already seen that we can check if a mock has been called or not. But we can also check the details of the calls to the mock.</p>
<p>Let's take the following example:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.level_7.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServerInterface</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
<p>We want to test the <code>send_messages</code> method.</p>
<p>Let's test what happens when the method is called with a single message:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_send_messages_one_message</span><span class="p">(</span><span class="n">mock_interface</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">mock_interface</span><span class="p">)</span>

    <span class="n">session</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="s2">&quot;Hello, World&quot;</span><span class="p">])</span>

    <span class="n">mock_interface</span><span class="o">.</span><span class="n">send_message</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s2">&quot;Hello, World&quot;</span><span class="p">)</span>
</code></pre></div>
<p>We check that the mock was called with the correct argument using <code>assert_called_once_with</code>.</p>
<p>Let's add a test for a call with multiple messages:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_send_messages_multiple_messages</span><span class="p">(</span><span class="n">mock_interface</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">mock_interface</span><span class="p">)</span>

    <span class="n">session</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="s2">&quot;Hello, World&quot;</span><span class="p">,</span> <span class="s2">&quot;Hello, Universe&quot;</span><span class="p">])</span>

    <span class="c1"># We can check the number of calls to the mock</span>
    <span class="k">assert</span> <span class="n">mock_interface</span><span class="o">.</span><span class="n">send_message</span><span class="o">.</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="c1"># We can check the order and content of the calls to the mock</span>
    <span class="c1"># You can set the &quot;any_order&quot; flag to True if you don&#39;t want to check the order of the calls, the default is False</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">send_message</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="s2">&quot;Hello, World&quot;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">(</span><span class="s2">&quot;Hello, Universe&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
<p>We check the number of calls to the mock, as well as the order and content of the calls.</p>
<div class="admonition tip">
<p class="admonition-title">Order of mock calls</p>
<p>You can set the <code>any_order</code> flag of <code>assert_has_calls</code> to <code>True</code> if the order of the calls shouldn't matter.</p>
</div>
<h4 id="exceptions">Exceptions</h4>
<p>There are two cases where we need to handle exceptions in our tests:</p>
<ul>
<li>the code is supposed to catch an exception</li>
<li>the code is supposed to raise an exception</li>
</ul>
<p>Let's take the following example:</p>
<div class="highlight"><span class="filename">session.py</span><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.level_8.interface</span><span class="w"> </span><span class="kn">import</span> <span class="n">ServerInterface</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SessionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
    <span class="n">interface</span><span class="p">:</span> <span class="n">ServerInterface</span>
    <span class="n">connected</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ServerInterface</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_connection_errors</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_connection_errors</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to connect to server&quot;</span>
            <span class="k">raise</span> <span class="n">SessionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div>
<p>As before, we start by defining a fixture for the <code>ServerInterface</code> class:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_interface_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">MagicMock</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;src.level_8.session.ServerInterface&quot;</span><span class="p">,</span> <span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">mock</span>
</code></pre></div>
<h5 id="check-that-an-exception-is-caught">Check that an exception is caught</h5>
<p>Let's test that the <code>connect</code> method catches the <code>ConnectionError</code> exception raised by the <code>interface.connect_to_server</code> method:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_interface_exception</span><span class="p">(</span><span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Failed to connect to server&quot;</span><span class="p">)</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">ignore_connection_errors</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">connected</span>
</code></pre></div>
<p>This is another purpose of the <code>side_effect</code> attribute: if provided with an exception class or instance, the mock will raise that exception instead of returning a value.</p>
<div class="admonition tip">
<p class="admonition-title">Clearing a side effect</p>
<p>A <code>side_effect</code> can be cleared by setting it to None</p>
</div>
<h5 id="check-that-an-exception-is-raised">Check that an exception is raised</h5>
<p>Let's test that the <code>connect</code> method raises the <code>SessionError</code> exception when expected:</p>
<div class="highlight"><span class="filename">test_session.py</span><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">test_connect_session_exception</span><span class="p">(</span><span class="n">mock_interface_class</span><span class="p">:</span> <span class="n">MagicMock</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mock_interface</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ServerInterface</span><span class="p">)</span>
    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mock_interface_class</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_interface</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

    <span class="c1"># The match argument allows us to check that the exception message matches a specific regex pattern.</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">SessionError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Failed to connect to server&quot;</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">mock_interface</span><span class="o">.</span><span class="n">connect_to_server</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
</code></pre></div>
<p>Since the code under test raises an exception, we need the test to catch it or it will crash. We also want to check that the exception was raised, that it's the correct exception type and that it's the correct message.
<code>pytest.raises</code> allows us to do all of this.</p>
<div class="admonition tip">
<p class="admonition-title">Match of pytest.raises</p>
<p>The match argument allows us to check that the exception message matches a specific regex pattern, not just a static string.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>